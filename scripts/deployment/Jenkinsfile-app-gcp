#!/usr/bin/env groovy

import hudson.model.*
import hudson.EnvVars
import java.io

dev projectid = "agileretro-232800"
def versionbase =  new File('scripts/deployment/version.app').text
dev version =  "${versionbase}.${env.BUILD_ID}"

try {
  node {
    stage('Build'){
        steps {

          sh 'docker build -f scripts/deployment/build-app.dockerfile -t gcr.io/${projectid}/agile-retro-web:${version} .'
        }
    }
    stage('Test'){
      steps{
          sh 'echo "doing nothing" '
      }
    }
    stage('Push to Registry')
    {
      steps{
        sh 'docker push gcr.io/${projectid}/agile-retro-app:${version}'
      }
    }
    stage('Deploy'){
      steps{
        sh 'kubectl set image deployment agile-retro-web-deployment agile-retro-web=gcr.io/${projectid}/agile-retro-web:${version}'
      }
    }
  }
}
catch{

}