#!/usr/bin/env groovy

import hudson.model.*
import hudson.EnvVars
import hudson.FilePath


try {
  node {
    stage('Build'){
          def projectid = "agileretro-232800"
          def versionbase =  readFile("${env.WORKSPACE}/scripts/deployment/version.app")
          def version =  "${versionbase}.${env.BUILD_ID}"

          sh 'docker build -f scripts/deployment/build-app.dockerfile -t gcr.io/${projectid}/agile-retro-web:${version} .'
        
    }
    stage('Test'){
          sh 'echo "doing nothing" '
    }
    stage('Push to Registry')
    {
        sh 'docker push gcr.io/${projectid}/agile-retro-app:${version}'
    }
    stage('Deploy'){
        sh 'kubectl set image deployment agile-retro-web-deployment agile-retro-web=gcr.io/${projectid}/agile-retro-web:${version}'
    }
  }
}
catch (err){
    throw err

}